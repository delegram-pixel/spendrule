// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Contract {
  id                     String             @id @default(uuid())
  contractId             String             @unique
  vendorName             String
  effectiveDate          String // Using String for dates for simplicity with ISO format
  expirationDate         String
  pricingTerms           PricingTerm[]
  paymentTerms           String
  penaltyClauses         String[]
  complianceRequirements String[]
  confidence             Float
  pageReferences         Json
  comparisons            ComparisonResult[]
}

model PricingTerm {
  id                   String                @id @default(uuid())
  itemDescription      String
  unitPrice            Float
  unit                 String
  quantity             Int?
  conditions           String?
  pageNumber           Int
  confidence           Float
  contractId           String
  contract             Contract              @relation(fields: [contractId], references: [id])
  validationExceptions ValidationException[]
}

model Invoice {
  id            String             @id @default(uuid())
  invoiceId     String             @unique
  invoiceNumber String
  vendorName    String
  invoiceDate   String
  dueDate       String
  lineItems     InvoiceLineItem[]
  totalAmount   Float
  confidence    Float
  comparisons   ComparisonResult[]
}

model InvoiceLineItem {
  id          String                @id @default(uuid())
  description String
  quantity    Int
  unitPrice   Float
  totalPrice  Float
  pageNumber  Int
  invoiceId   String
  invoice     Invoice               @relation(fields: [invoiceId], references: [id])
  exceptions  ValidationException[]
}

model ComparisonResult {
  id               String                @id @default(uuid())
  invoiceId        String
  invoice          Invoice               @relation(fields: [invoiceId], references: [id])
  contractId       String
  contract         Contract              @relation(fields: [contractId], references: [id])
  overallMatch     Boolean
  confidence       Float
  exceptions       ValidationException[]
  totalVariance    Float
  potentialSavings Float
}

model ValidationException {
  id             String           @id @default(uuid())
  type           String // Enum: "price_mismatch" | "quantity_exceeded" | "unauthorized_item" | "expired_contract"
  severity       String // Enum: "critical" | "warning" | "info"
  lineItemId     String
  lineItem       InvoiceLineItem  @relation(fields: [lineItemId], references: [id])
  contractTermId String?
  contractTerm   PricingTerm?     @relation(fields: [contractTermId], references: [id])
  variance       Float
  description    String
  proofData      Json
  comparisonId   String
  comparison     ComparisonResult @relation(fields: [comparisonId], references: [id])
}

model AnalysisReport {
  id                     String   @id @default(uuid())
  totalInvoicesProcessed Int
  totalExceptions        Int
  totalSavings           Float
  averageConfidence      Float
  topVendorIssues        Json
  categoryBreakdown      Json
  recommendations        String[]
}
